{% extends 'base.html' %}

{% block title %}监控中心 - PyOps{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">监控中心</h1>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">CPU使用率</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="display-4" id="cpu-usage">0%</span>
                        <div class="w-50">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-danger" id="cpu-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">内存使用率</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="display-4" id="memory-usage">0%</span>
                        <div class="w-50">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-warning" id="memory-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">磁盘使用率</h5>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="display-4" id="disk-usage">0%</span>
                        <div class="w-50">
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-info" id="disk-progress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">网络流量</h5>
                    <canvas id="networkChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">系统负载</h5>
                    <canvas id="loadChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 初始化图表
    document.addEventListener('DOMContentLoaded', function() {
        // 网络流量图表
        const networkCtx = document.getElementById('networkChart').getContext('2d');
        const networkChart = new Chart(networkCtx, {
            type: 'line',
            data: {
                labels: ['', '', '', '', '', '', ''],
                datasets: [
                    {
                        label: '流入 (B/s)',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    },
                    {
                        label: '流出 (B/s)',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        borderColor: 'rgb(255, 99, 132)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 系统负载图表
        const loadCtx = document.getElementById('loadChart').getContext('2d');
        const loadChart = new Chart(loadCtx, {
            type: 'bar',
            data: {
                labels: ['CPU', '内存', '磁盘', '网络'],
                datasets: [{
                    label: '使用率 (%)',
                    data: [0, 0, 0, 0],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(255, 205, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)'
                    ],
                    borderColor: [
                        'rgb(255, 99, 132)',
                        'rgb(255, 159, 64)',
                        'rgb(255, 205, 86)',
                        'rgb(75, 192, 192)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });

        // 定期获取监控数据
        function updateMonitorData() {
            fetch('/monitor/data')
                .then(response => response.json())
                .then(data => {
                    if (data.code === 0) {
                        const monitorData = data.data;
                        
                        // 更新CPU使用率
                        document.getElementById('cpu-usage').textContent = monitorData.cpu_usage + '%';
                        document.getElementById('cpu-progress').style.width = monitorData.cpu_usage + '%';
                        document.getElementById('cpu-progress').setAttribute('aria-valuenow', monitorData.cpu_usage);
                        
                        // 更新内存使用率
                        document.getElementById('memory-usage').textContent = monitorData.memory_usage + '%';
                        document.getElementById('memory-progress').style.width = monitorData.memory_usage + '%';
                        document.getElementById('memory-progress').setAttribute('aria-valuenow', monitorData.memory_usage);
                        
                        // 更新磁盘使用率
                        document.getElementById('disk-usage').textContent = monitorData.disk_usage + '%';
                        document.getElementById('disk-progress').style.width = monitorData.disk_usage + '%';
                        document.getElementById('disk-progress').setAttribute('aria-valuenow', monitorData.disk_usage);
                        
                        // 更新网络流量图表
                        networkChart.data.datasets[0].data.shift();
                        networkChart.data.datasets[0].data.push(monitorData.network_in);
                        networkChart.data.datasets[1].data.shift();
                        networkChart.data.datasets[1].data.push(monitorData.network_out);
                        networkChart.update();
                        
                        // 更新系统负载图表
                        loadChart.data.datasets[0].data = [
                            monitorData.cpu_usage,
                            monitorData.memory_usage,
                            monitorData.disk_usage,
                            Math.max(monitorData.network_in, monitorData.network_out) / 1000
                        ];
                        loadChart.update();
                    }
                });
        }

        // 立即更新一次
        updateMonitorData();
        
        // 每5秒更新一次
        setInterval(updateMonitorData, 5000);
    });
</script>
{% endblock %}